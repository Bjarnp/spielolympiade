<div class="dashboard">
  <div class="info" *ngIf="!seasonActive">
    <p>
      Die Spielolympiade beginnt bald!
      <a routerLink="/history">Werfe doch ein Blick in die Historie!</a>
    </p>
    <button
      mat-raised-button
      color="accent"
      *ngIf="auth.getUser()?.role === 'admin'"
      routerLink="/start-season"
    >
      Neue Saison starten
    </button>
  </div>

  <ng-container *ngIf="seasonActive">
  <button
      mat-raised-button
      color="warn"
      *ngIf="auth.getUser()?.role === 'admin'"
      (click)="deleteSeason()"
    >Saison löschen</button>

  <div class="view-switch" *ngIf="tournamentSystem === 'group_ko'">
    <mat-form-field>
      <mat-select [(ngModel)]="viewMode">
        <mat-option value="overall">Gesamtübersicht</mat-option>
        <mat-option *ngFor="let g of allGames" [value]="g.id">{{ g.name }}</mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <section class="table-section" *ngIf="tableData.length && (viewMode === 'overall' || tournamentSystem !== 'group_ko')">
    <mat-card class="table-card">
      <mat-card-title>Spielolympiade {{ seasonYear }}</mat-card-title>
      <div class="table-wrapper">
        <table mat-table [dataSource]="dataSource" class="season-table mat-elevation-z8" matSort>
        <ng-container matColumnDef="place">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="place">Platz</th>
          <td mat-cell *matCellDef="let element; index as i">{{ i + 1 }}</td>
        </ng-container>

        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="name">Team</th>
          <td mat-cell *matCellDef="let element">{{ element.name }}</td>
        </ng-container>

        <ng-container matColumnDef="spiele">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="spiele">Spiele</th>
          <td mat-cell *matCellDef="let element">{{ element.spiele }}</td>
        </ng-container>

        <ng-container matColumnDef="siege">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="siege">Siege</th>
          <td mat-cell *matCellDef="let element">{{ element.siege }}</td>
        </ng-container>

        <ng-container matColumnDef="niederlagen">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="niederlagen">Niederl.</th>
          <td mat-cell *matCellDef="let element">{{ element.niederlagen }}</td>
        </ng-container>

        <ng-container matColumnDef="punkte">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="punkte">Punkte</th>
          <td mat-cell *matCellDef="let element">{{ element.points }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

        </table>
      </div>
    </mat-card>
  </section>

  <section *ngIf="tournamentSystem === 'group_ko' && viewMode !== 'overall'">
    <h3>{{ getGameName(viewMode) }} - Gruppen</h3>
    <div class="groups" *ngFor="let group of ['A','B']">
      <h4>Gruppe {{ group }}</h4>
      <table class="result-table">
        <tr>
          <th>Team</th>
          <th>Punkte</th>
        </tr>
        <tr *ngFor="let row of groupStandings(viewMode)[group]">
          <td>{{ getTeamName(row.teamId) }}</td>
          <td>{{ row.points }}</td>
        </tr>
      </table>
    </div>
    <h4>K.O.-Phase</h4>
    <ul>
      <li *ngFor="let m of koMatchesFor(viewMode)">
        {{ getTeamName(m.team1Id) }} vs {{ getTeamName(m.team2Id) }} -
        <ng-container *ngIf="m.team1Score != null && m.team2Score != null; else open">
          {{ m.team1Score }} : {{ m.team2Score }}
        </ng-container>
        <ng-template #open>noch offen</ng-template>
      </li>
    </ul>
  </section>

  <section *ngIf="team">
    <h2>Dein Team</h2>
    <p>{{ team.name }}</p>
  </section>

  <section *ngIf="activeGameDay">
    <h2>Spiele</h2>
    <h3>Aktuelle Begegnungen</h3>
    <div class="filters">
      <button mat-raised-button (click)="setFilter('all')">Alle Begegnungen</button>
      <button mat-raised-button (click)="setFilter('open')">Offen</button>
      <button mat-raised-button (click)="setFilter('played')">Gespielt</button>
      <mat-checkbox [(ngModel)]="onlyMine" (change)="applyFilters()">Nur meine Spiele</mat-checkbox>
    </div>
    <ul>
      <li *ngFor="let r of filteredGames">
        {{ getGameName(r.gameId) }} |
        {{ getTeamName(r.team1Id) }}
        <ng-container *ngIf="auth.getUser()?.role === 'admin'; else view1">
          <select [(ngModel)]="r.team1Score" (ngModelChange)="setWinner(r, $event == null ? 'none' : ($event == 1 ? 'team1' : 'team2'))">
            <option [ngValue]="null">offen</option>
            <option [ngValue]="1">gewonnen</option>
            <option [ngValue]="0">verloren</option>
          </select>
        </ng-container>
        <ng-template #view1>({{ r.team1Score ?? '-' }})</ng-template>
        –
        {{ getTeamName(r.team2Id) }}
        <ng-container *ngIf="auth.getUser()?.role === 'admin'; else view2">
          <select [(ngModel)]="r.team2Score" (ngModelChange)="setWinner(r, $event == null ? 'none' : ($event == 1 ? 'team2' : 'team1'))">
            <option [ngValue]="null">offen</option>
            <option [ngValue]="1">gewonnen</option>
            <option [ngValue]="0">verloren</option>
          </select>
        </ng-container>
        <ng-template #view2>({{ r.team2Score ?? '-' }})</ng-template>
        <button *ngIf="auth.getUser()?.role === 'admin'" mat-icon-button color="accent" (click)="toggleSave(r)">
          <mat-icon>{{ r.saved ? 'edit' : 'save' }}</mat-icon>
        </button>
      </li>
    </ul>
    <div *ngIf="auth.getUser()?.role === 'admin'" class="new-match">
      <h4>Neues Spiel</h4>
      <select [(ngModel)]="newMatch.team1Id">
        <option value="" disabled selected>Team 1</option>
        <option *ngFor="let t of allTeams" [value]="t.id">{{ t.name }}</option>
      </select>
      <select [(ngModel)]="newMatch.team2Id">
        <option value="" disabled selected>Team 2</option>
        <option *ngFor="let t of allTeams" [value]="t.id">{{ t.name }}</option>
      </select>
      <select [(ngModel)]="newMatch.gameId">
        <option value="" disabled selected>Spiel</option>
        <option *ngFor="let g of allGames" [value]="g.id">{{ g.name }}</option>
      </select>
      <button mat-raised-button color="primary" (click)="createMatch()">Anlegen</button>
    </div>
  </section>



  </ng-container>
</div>
