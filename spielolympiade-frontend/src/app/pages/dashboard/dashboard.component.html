<div class="dashboard">
  <div class="info" *ngIf="!seasonActive">
    <p>
      Die Spielolympiade beginnt bald!
      <a routerLink="/history">Werfe doch ein Blick in die Historie!</a>
    </p>
    <button
      mat-raised-button
      color="accent"
      *ngIf="auth.getUser()?.role === 'admin'"
      routerLink="/start-season"
    >
      Neue Saison starten
    </button>
  </div>

  <ng-container *ngIf="seasonActive">
    <button
      mat-raised-button
      color="warn"
      *ngIf="auth.getUser()?.role === 'admin'"
      (click)="deleteSeason()"
    >Saison löschen</button>

    <div class="view-switch" *ngIf="tournamentSystem === 'group_ko'">
      <mat-form-field appearance="fill">
        <mat-select [(ngModel)]="viewMode">
          <mat-option value="overall">Gesamtübersicht</mat-option>
          <mat-option *ngFor="let g of allGames" [value]="g.id">{{ g.name }}</mat-option>
        </mat-select>
      </mat-form-field>
    </div>

  <section class="table-section" *ngIf="tableData.length && (viewMode === 'overall' || tournamentSystem !== 'group_ko')">
    <mat-card class="table-card">
      <mat-card-title>Spielolympiade {{ seasonYear }}</mat-card-title>
      <div class="table-wrapper">
        <table mat-table [dataSource]="dataSource" class="season-table mat-elevation-z8" matSort>
        <ng-container matColumnDef="place">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="place">Platz</th>
          <td mat-cell *matCellDef="let element; index as i">{{ i + 1 }}</td>
        </ng-container>

        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="name">Team</th>
          <td mat-cell *matCellDef="let element">{{ element.name }}</td>
        </ng-container>

        <ng-container matColumnDef="spiele">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="spiele">Spiele</th>
          <td mat-cell *matCellDef="let element">{{ element.spiele }}</td>
        </ng-container>

        <ng-container matColumnDef="siege">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="siege">Siege</th>
          <td mat-cell *matCellDef="let element">{{ element.siege }}</td>
        </ng-container>

        <ng-container matColumnDef="niederlagen">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="niederlagen">Niederl.</th>
          <td mat-cell *matCellDef="let element">{{ element.niederlagen }}</td>
        </ng-container>

        <ng-container matColumnDef="punkte">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="punkte">Punkte</th>
          <td mat-cell *matCellDef="let element">{{ element.points }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

        </table>
      </div>
    </mat-card>
  </section>

  <section *ngIf="tournamentSystem === 'group_ko' && viewMode !== 'overall'">
    <mat-card class="group-card">
      <mat-card-title>{{ getGameName(viewMode) }} - Gruppen</mat-card-title>
      <mat-card-content>
        <div class="groups" *ngFor="let group of ['A','B']">
          <h4>Gruppe {{ group }}</h4>
          <table mat-table [dataSource]="groupStandings(viewMode)[group]" class="result-table">
            <ng-container matColumnDef="team">
              <th mat-header-cell *matHeaderCellDef>Team</th>
              <td mat-cell *matCellDef="let row">{{ getTeamName(row.teamId) }}</td>
            </ng-container>
            <ng-container matColumnDef="points">
              <th mat-header-cell *matHeaderCellDef>Punkte</th>
              <td mat-cell *matCellDef="let row">{{ row.points }}</td>
            </ng-container>
            <tr mat-header-row *matHeaderRowDef="['team','points']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['team','points']"></tr>
          </table>
        </div>
        <h4>K.O.-Phase</h4>
        <mat-list>
          <mat-list-item *ngFor="let m of koMatchesFor(viewMode)">
            {{ getTeamName(m.team1Id) }} vs {{ getTeamName(m.team2Id) }} -
            <ng-container *ngIf="m.team1Score != null && m.team2Score != null; else open">
              {{ m.team1Score }} : {{ m.team2Score }}
            </ng-container>
            <ng-template #open>noch offen</ng-template>
          </mat-list-item>
        </mat-list>
      </mat-card-content>
    </mat-card>
  </section>

  <section *ngIf="team">
    <mat-card>
      <mat-card-title>Dein Team</mat-card-title>
      <mat-card-content>
        {{ team.name }}
      </mat-card-content>
    </mat-card>
  </section>

  <section *ngIf="activeGameDay">
    <mat-card class="matches-card">
      <mat-card-title>Spiele</mat-card-title>
      <mat-card-content>
        <h3>Aktuelle Begegnungen</h3>
        <div class="filters">
          <button mat-raised-button (click)="setFilter('all')">Alle Begegnungen</button>
          <button mat-raised-button (click)="setFilter('open')">Offen</button>
          <button mat-raised-button (click)="setFilter('played')">Gespielt</button>
          <mat-checkbox [(ngModel)]="onlyMine" (change)="applyFilters()">Nur meine Spiele</mat-checkbox>
        </div>
        <mat-list>
          <mat-list-item *ngFor="let r of filteredGames" class="match-item">
            {{ getGameName(r.gameId) }} |
            {{ getTeamName(r.team1Id) }}
            <ng-container *ngIf="auth.getUser()?.role === 'admin'; else view1">
              <mat-form-field appearance="fill" class="score-select">
                <mat-select [(ngModel)]="r.team1Score" (selectionChange)="setWinner(r, $event.value == null ? 'none' : ($event.value == 1 ? 'team1' : 'team2'))">
                  <mat-option [value]="null">offen</mat-option>
                  <mat-option [value]="1">gewonnen</mat-option>
                  <mat-option [value]="0">verloren</mat-option>
                </mat-select>
              </mat-form-field>
            </ng-container>
            <ng-template #view1>({{ r.team1Score ?? '-' }})</ng-template>
            –
            {{ getTeamName(r.team2Id) }}
            <ng-container *ngIf="auth.getUser()?.role === 'admin'; else view2">
              <mat-form-field appearance="fill" class="score-select">
                <mat-select [(ngModel)]="r.team2Score" (selectionChange)="setWinner(r, $event.value == null ? 'none' : ($event.value == 1 ? 'team2' : 'team1'))">
                  <mat-option [value]="null">offen</mat-option>
                  <mat-option [value]="1">gewonnen</mat-option>
                  <mat-option [value]="0">verloren</mat-option>
                </mat-select>
              </mat-form-field>
            </ng-container>
            <ng-template #view2>({{ r.team2Score ?? '-' }})</ng-template>
            <button *ngIf="auth.getUser()?.role === 'admin'" mat-icon-button color="accent" (click)="toggleSave(r)">
              <mat-icon>{{ r.saved ? 'edit' : 'save' }}</mat-icon>
            </button>
          </mat-list-item>
        </mat-list>
        <mat-divider></mat-divider>
        <div *ngIf="auth.getUser()?.role === 'admin'" class="new-match-form">
          <mat-form-field appearance="fill">
            <mat-select placeholder="Team 1" [(ngModel)]="newMatch.team1Id">
              <mat-option *ngFor="let t of allTeams" [value]="t.id">{{ t.name }}</mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-select placeholder="Team 2" [(ngModel)]="newMatch.team2Id">
              <mat-option *ngFor="let t of allTeams" [value]="t.id">{{ t.name }}</mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-select placeholder="Spiel" [(ngModel)]="newMatch.gameId">
              <mat-option *ngFor="let g of allGames" [value]="g.id">{{ g.name }}</mat-option>
            </mat-select>
          </mat-form-field>
          <button mat-raised-button color="primary" (click)="createMatch()">Anlegen</button>
        </div>
      </mat-card-content>
    </mat-card>
  </section>



  </ng-container>
</div>
