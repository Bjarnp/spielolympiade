<div class="dashboard">
  <div class="info" *ngIf="!seasonActive">
    <p>
      Die Spielolympiade beginnt bald! Die nächste Spielolympiade ist dieses
      Jahr 2025.
      <a routerLink="/history">Werfe doch ein Blick in die Historie!</a>
    </p>
    <button
      mat-raised-button
      color="accent"
      *ngIf="auth.getUser()?.role === 'admin'"
      routerLink="/start-season"
    >
      Neue Saison starten
    </button>
  </div>

  <ng-container *ngIf="seasonActive">
    <div class="view-switch" *ngIf="tournamentSystem === 'group_ko'">
      <mat-form-field appearance="fill">
        <mat-select [(ngModel)]="viewMode">
          <mat-option value="overall">Gesamtübersicht</mat-option>
          <mat-option *ngFor="let g of allGames" [value]="g.id">{{
            g.name
          }}</mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <section
      class="table-section"
      *ngIf="
        tableData.length &&
        (viewMode === 'overall' || tournamentSystem !== 'group_ko')
      "
    >
      <mat-card class="table-card">
        <mat-card-title>Spielolympiade {{ seasonYear }}</mat-card-title>
        <div class="table-wrapper">
          <table
            mat-table
            [dataSource]="dataSource"
            class="season-table mat-elevation-z8"
            matSort
          >
            <ng-container matColumnDef="place">
              <th mat-header-cell *matHeaderCellDef mat-sort-header="place">
                Platz
              </th>
              <td mat-cell *matCellDef="let element; index as i">
                {{ i + 1 }}
              </td>
            </ng-container>

            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef mat-sort-header="name">
                Team
              </th>
              <td mat-cell *matCellDef="let element">{{ element.name }}</td>
            </ng-container>

            <ng-container matColumnDef="spiele">
              <th mat-header-cell *matHeaderCellDef mat-sort-header="spiele">
                Spiele
              </th>
              <td mat-cell *matCellDef="let element">{{ element.spiele }}</td>
            </ng-container>

            <ng-container matColumnDef="siege">
              <th mat-header-cell *matHeaderCellDef mat-sort-header="siege">
                Siege
              </th>
              <td mat-cell *matCellDef="let element">{{ element.siege }}</td>
            </ng-container>

            <ng-container matColumnDef="niederlagen">
              <th
                mat-header-cell
                *matHeaderCellDef
                mat-sort-header="niederlagen"
              >
                Niederl.
              </th>
              <td mat-cell *matCellDef="let element">
                {{ element.niederlagen }}
              </td>
            </ng-container>

            <ng-container matColumnDef="punkte">
              <th mat-header-cell *matHeaderCellDef mat-sort-header="punkte">
                Punkte
              </th>
              <td mat-cell *matCellDef="let element">{{ element.points }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>
        </div>
      </mat-card>
    </section>

    <section *ngIf="tournamentSystem === 'group_ko' && viewMode !== 'overall'">
      <mat-card class="group-card">
        <mat-card-title>{{ getGameName(viewMode) }} - Gruppen</mat-card-title>
        <mat-card-content>
          <div class="groups" *ngFor="let group of ['A', 'B']">
            <h4>Gruppe {{ group }}</h4>
            <table
              mat-table
              [dataSource]="groupStandings(viewMode)[group]"
              class="result-table"
            >
              <ng-container matColumnDef="team">
                <th mat-header-cell *matHeaderCellDef>Team</th>
                <td mat-cell *matCellDef="let row">
                  {{ getTeamName(row.teamId) }}
                </td>
              </ng-container>
              <ng-container
                *ngIf="groupPhaseComplete(viewMode)"
                matColumnDef="points"
              >
                <th mat-header-cell *matHeaderCellDef>Punkte</th>
                <td mat-cell *matCellDef="let row">{{ row.points }}</td>
              </ng-container>
              <tr
                mat-header-row
                *matHeaderRowDef="
                  groupPhaseComplete(viewMode) ? ['team', 'points'] : ['team']
                "
              ></tr>
              <tr
                mat-row
                *matRowDef="
                  let row;
                  columns: groupPhaseComplete(viewMode)
                    ? ['team', 'points']
                    : ['team']
                "
              ></tr>
            </table>
          </div>
          <div *ngIf="overallStandings(viewMode).length" class="overall-table">
            <h4>Gesamtwertung</h4>
            <table
              mat-table
              [dataSource]="overallStandings(viewMode)"
              class="result-table"
            >
              <ng-container matColumnDef="rank">
                <th mat-header-cell *matHeaderCellDef>Platz</th>
                <td mat-cell *matCellDef="let row">{{ row.rank }}</td>
              </ng-container>
              <ng-container matColumnDef="team">
                <th mat-header-cell *matHeaderCellDef>Team</th>
                <td mat-cell *matCellDef="let row">
                  {{ getTeamName(row.teamId) }}
                </td>
              </ng-container>
              <ng-container matColumnDef="ratio">
                <th mat-header-cell *matHeaderCellDef>Quote</th>
                <td mat-cell *matCellDef="let row">
                  {{ row.ratio | number : "1.2-2" }}
                </td>
              </ng-container>
              <ng-container matColumnDef="points">
                <th mat-header-cell *matHeaderCellDef>Punkte</th>
                <td mat-cell *matCellDef="let row">{{ row.points }}</td>
              </ng-container>
              <tr
                mat-header-row
                *matHeaderRowDef="['rank', 'team', 'ratio', 'points']"
              ></tr>
              <tr
                mat-row
                *matRowDef="let row; columns: ['rank', 'team', 'ratio', 'points']"
              ></tr>
            </table>
          </div>
          <h4>K.O.-Phase</h4>
          <mat-list>
            <mat-list-item *ngFor="let m of koMatchesFor(viewMode)">
              <strong>{{ stageLabel(m.stage) }}:</strong>
              {{ getTeamName(m.team1Id) }} vs {{ getTeamName(m.team2Id) }} -
              <ng-container
                *ngIf="m.team1Score != null && m.team2Score != null; else open"
              >
                {{ m.team1Score }} : {{ m.team2Score }}
              </ng-container>
              <ng-template #open>noch offen</ng-template>
            </mat-list-item>
          </mat-list>
        </mat-card-content>
      </mat-card>
    </section>

    <section *ngIf="team">
      <mat-card>
        <mat-card-title>Dein Team</mat-card-title>
        <mat-card-content>
          {{ team.name }}
        </mat-card-content>
      </mat-card>
    </section>

    <section *ngIf="activeGameDay">
      <h2>Spiele</h2>
      <div *ngIf="recommendations.length" class="recommendations">
        <h3>Empfohlene nächste Spiele</h3>
        <ul>
          <li *ngFor="let g of recommendations | slice : 0 : 5">
            {{ getGameName(g.gameId) }}: {{ getTeamName(g.team1Id) }} vs
            {{ getTeamName(g.team2Id) }}
          </li>
        </ul>
      </div>
      <div class="new-match" *ngIf="auth.getUser()?.role === 'admin'">
        <h3>Spiel hinzufügen</h3>
        <mat-form-field appearance="fill">
          <mat-select [(ngModel)]="newMatch.gameId" placeholder="Spiel">
            <mat-option *ngFor="let g of allGames" [value]="g.id">
              {{ g.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="fill">
          <mat-select [(ngModel)]="newMatch.team1Id" placeholder="Team 1">
            <mat-option *ngFor="let t of allTeams" [value]="t.id">
              {{ t.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="fill">
          <mat-select [(ngModel)]="newMatch.team2Id" placeholder="Team 2">
            <mat-option *ngFor="let t of allTeams" [value]="t.id">
              {{ t.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <button mat-raised-button color="primary" (click)="createMatch()">
          Anlegen
        </button>
      </div>
      <div class="filters">
        <button mat-raised-button (click)="setFilter('all')">
          Alle Begegnungen
        </button>
        <button mat-raised-button (click)="setFilter('open')">Offen</button>
        <button mat-raised-button (click)="setFilter('played')">
          Gespielt
        </button>
        <mat-checkbox [(ngModel)]="onlyMine" (change)="applyFilters()"
          >Nur meine Spiele</mat-checkbox
        >
      </div>
      <table class="result-table">
        <thead>
          <tr>
            <th>Spiel</th>
            <th>Team 1</th>
            <th>Ergebnis</th>
            <th>Team 2</th>
            <th>Ergebnis</th>
            <th *ngIf="auth.getUser()?.role === 'admin'"></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let r of filteredGames">
            <td>{{ getGameName(r.gameId) }}</td>
            <td>{{ getTeamName(r.team1Id) }}</td>
            <td>
              <ng-container
                *ngIf="auth.getUser()?.role === 'admin'; else t1score"
              >
                <mat-form-field appearance="fill" class="score-select">
                  <mat-select
                    [ngModel]="r.team1Score"
                    (ngModelChange)="updateResult(r, 'team1', $event)"
                  >
                    <mat-option [value]="1">gewonnen</mat-option>
                    <mat-option [value]="0">verloren</mat-option>
                  </mat-select>
                </mat-form-field>
              </ng-container>
              <ng-template #t1score>{{ r.team1Score ?? "-" }}</ng-template>
            </td>
            <td>{{ getTeamName(r.team2Id) }}</td>
            <td>
              <ng-container
                *ngIf="auth.getUser()?.role === 'admin'; else t2score"
              >
                <mat-form-field appearance="fill" class="score-select">
                  <mat-select
                    [ngModel]="r.team2Score"
                    (ngModelChange)="updateResult(r, 'team2', $event)"
                  >
                    <mat-option [value]="1">gewonnen</mat-option>
                    <mat-option [value]="0">verloren</mat-option>
                  </mat-select>
                </mat-form-field>
              </ng-container>
              <ng-template #t2score>{{ r.team2Score ?? "-" }}</ng-template>
            </td>
            <td class="action-cell" *ngIf="auth.getUser()?.role === 'admin'">
              <button mat-icon-button color="accent" (click)="toggleSave(r)">
                <mat-icon>{{ r.saved ? "edit" : "save" }}</mat-icon>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </section>
    <button
      mat-raised-button
      color="primary"
      *ngIf="auth.getUser()?.role === 'admin'"
      (click)="finishSeason()"
    >
      Saison speichern
    </button>
    <div class="delete-wrapper" *ngIf="auth.getUser()?.role === 'admin'">
      <button mat-raised-button color="warn" (click)="deleteSeason()">
        Saison löschen
      </button>
    </div>
  </ng-container>
</div>
