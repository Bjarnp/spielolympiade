<div class="dashboard">
  <div class="info" *ngIf="!seasonActive">
    <p>
      Die Spielolympiade beginnt bald!
      <a routerLink="/history">Werfe doch ein Blick in die Historie!</a>
    </p>
    <button
      mat-raised-button
      color="accent"
      *ngIf="auth.getUser()?.role === 'admin'"
      routerLink="/start-season"
    >
      Neue Saison starten
    </button>
  </div>

  <ng-container *ngIf="seasonActive">
  <button
      mat-raised-button
      color="warn"
      *ngIf="auth.getUser()?.role === 'admin'"
      (click)="deleteSeason()"
    >Saison löschen</button>

  <div class="view-switch" *ngIf="tournamentSystem === 'group_ko'">
    <mat-form-field>
      <mat-select [(ngModel)]="viewMode">
        <mat-option value="overall">Gesamtübersicht</mat-option>
        <mat-option *ngFor="let g of allGames" [value]="g.id">{{ g.name }}</mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <section class="table-section" *ngIf="tableData.length && (viewMode === 'overall' || tournamentSystem !== 'group_ko')">
    <mat-card class="table-card">
      <mat-card-title>Spielolympiade {{ seasonYear }}</mat-card-title>
      <div class="table-wrapper">
        <table mat-table [dataSource]="dataSource" class="season-table mat-elevation-z8" matSort>
        <ng-container matColumnDef="place">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="place">Platz</th>
          <td mat-cell *matCellDef="let element; index as i">{{ i + 1 }}</td>
        </ng-container>

        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="name">Team</th>
          <td mat-cell *matCellDef="let element">{{ element.name }}</td>
        </ng-container>

        <ng-container matColumnDef="spiele">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="spiele">Spiele</th>
          <td mat-cell *matCellDef="let element">{{ element.spiele }}</td>
        </ng-container>

        <ng-container matColumnDef="siege">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="siege">Siege</th>
          <td mat-cell *matCellDef="let element">{{ element.siege }}</td>
        </ng-container>

        <ng-container matColumnDef="niederlagen">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="niederlagen">Niederl.</th>
          <td mat-cell *matCellDef="let element">{{ element.niederlagen }}</td>
        </ng-container>

        <ng-container matColumnDef="punkte">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="punkte">Punkte</th>
          <td mat-cell *matCellDef="let element">{{ element.points }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

        </table>
      </div>
    </mat-card>
  </section>

  <section *ngIf="tournamentSystem === 'group_ko' && viewMode !== 'overall'">
    <h3>{{ getGameName(viewMode) }} - Gruppen</h3>
    <div class="groups" *ngFor="let group of ['A','B']">
      <h4>Gruppe {{ group }}</h4>
      <table class="result-table">
        <tr>
          <th>Team</th>
          <th>Punkte</th>
        </tr>
        <tr *ngFor="let row of groupStandings(viewMode)[group]">
          <td>{{ getTeamName(row.teamId) }}</td>
          <td>{{ row.points }}</td>
        </tr>
      </table>
    </div>
    <h4>K.O.-Phase</h4>
    <ul>
      <li *ngFor="let m of allMatches.filter(m => m.gameId===viewMode && m.stage !== 'group')">
        {{ getTeamName(m.team1Id) }} vs {{ getTeamName(m.team2Id) }} -
        <ng-container *ngIf="m.team1Score != null && m.team2Score != null; else open">
          {{ m.team1Score }} : {{ m.team2Score }}
        </ng-container>
        <ng-template #open>noch offen</ng-template>
      </li>
    </ul>
  </section>

  <section *ngIf="team">
    <h2>Dein Team</h2>
    <p>{{ team.name }}</p>
  </section>

  <section *ngIf="activeGameDay">
    <h2>Spiele</h2>
    <div class="filters">
      <button mat-raised-button (click)="setFilter('all')">Alle Begegnungen</button>
      <button mat-raised-button (click)="setFilter('open')">Offen</button>
      <button mat-raised-button (click)="setFilter('played')">Gespielt</button>
      <mat-checkbox [(ngModel)]="onlyMine" (change)="applyFilters()">Nur meine Spiele</mat-checkbox>
    </div>
    <ul>
      <li *ngFor="let r of filteredGames">
        {{ getGameName(r.gameId) }} |
        {{ getTeamName(r.team1Id) }}
        <input *ngIf="auth.getUser()?.role === 'admin'" type="number" [(ngModel)]="r.team1Score" style="width:40px" />
        <span *ngIf="auth.getUser()?.role !== 'admin'">({{ r.team1Score ?? '-' }})</span>
        –
        {{ getTeamName(r.team2Id) }}
        <input *ngIf="auth.getUser()?.role === 'admin'" type="number" [(ngModel)]="r.team2Score" style="width:40px" />
        <span *ngIf="auth.getUser()?.role !== 'admin'">({{ r.team2Score ?? '-' }})</span>
        <button *ngIf="auth.getUser()?.role === 'admin'" mat-button color="accent" (click)="saveResultFor(r)">Speichern</button>
      </li>
    </ul>
  </section>



  </ng-container>
</div>
